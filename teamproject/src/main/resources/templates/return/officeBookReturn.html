<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
	  layout:decorator="@{layout/defaultAdmin}">

<th:block layout:fragment="customTitle">
	<title>반납 관리</title>
</th:block>
              
<th:block layout:fragment="customCss">
<link rel="stylesheet" href="../../plugins/datatables-bs4/css/dataTables.bootstrap4.min.css">
<link rel="stylesheet" href="../../plugins/datatables-responsive/css/responsive.bootstrap4.min.css">
<!-- overlayScrollbars -->
<link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
</th:block>
 
<th:block layout:fragment="customContents">
	<!-- Content Wrapper. Contains page content -->
	<div class="content-wrapper">
		<!-- Content Header (Page header) -->
		<div class="content-header">
			<div class="register-logo">
	    		<b>반납 등록</b>
	  		</div>
		</div>
		<!-- /.content-header -->
	 	<!-- Main content -->
		<section class="content" style="background-color: white">	
			<div class="card-header">
				<div class="row">            
                    <!-- BOOK SEARCH FORM -->
                	<div class="col-sm-2">			                
						<a>청구 기호</a>																							               																																				
                	</div>	
                   	<div class="col-sm-4">	                     	
                    	<div class="input-group input-group-sm">
                        	<input class="form-control" type="search" placeholder="#Book Library Code" aria-label="Search" id="searchBookLibraryCode">
                         	<div class="input-group-append">
                           		<button class="btn btn-navbar" type="submit" id="searchBook">
                             		<i class="fas fa-search"></i>
                           		</button>
                         	</div>
                        </div>
                    </div>
                     	<!-- /.BOOK SEARCH FORM -->
                     	
                     <!-- USER SEARCH FORM -->       
                	<div class="col-sm-2">			                
						<a>회원 아이디</a>																							               																																				
                	</div>
                   	<div class="col-sm-4">		                     	
                    	<div class="input-group input-group-sm">
                        	<input class="form-control" type="search" placeholder="#Member Id" aria-label="Search" id="searchMemberId">
                         	<div class="input-group-append">
                         		<button class="btn btn-navbar" type="submit" id="searchMember">
                            		<i class="fas fa-search"></i>
                          		</button>
                         	</div>
                      	</div>
                    </div>
		            	<!-- /.USER SEARCH FORM -->         	                    
	           </div>
	           	<!-- /.row -->
		</div>
	       <!-- /.card-header -->
	       
              <!-- form start -->
              <form action="/addBookReturn" method="post">
              <div class="row">
	              <div class="col-md-6">				
			            <div class="card card-white">
                <div class="card-body">
                  <div class="form-group row">
		                		<label for="inputEmail3" class="col-sm-2 col-form-label">청구기호</label>
			            		<div class="col-sm-10">
			            			<input type="text" class="form-control" placeholder="Library Book Code" name="bookLibraryCode">
			            		</div>
		                	</div>
	                  		<div class="form-group row">
	                  			<label for="inputEmail3" class="col-sm-2 col-form-label">도서 코드</label>
		                		<div class="col-sm-10">
		                        	<input type="text" class="form-control" placeholder="Book Code" name="bookCode">
		                    	</div>
		                  	</div>
				            <div class="form-group row">
			                    <label for="inputEmail3" class="col-sm-2 col-form-label">ISBN</label>
				                <div class="col-sm-10">
				                	<input type="text" class="form-control" placeholder="ISBN" name="bookIsbn">
				                </div>
			                </div>
		                    <div class="form-group row">
		                    	<label for="inputPassword3" class="col-sm-2 col-form-label">도서이름</label>
			                	<div class="col-sm-10">
			                		<input type="text" class="form-control" placeholder="Book Name" name="bookName">
			                	</div>
		                    </div>
		                    <div class="form-group row">
		                    	<label for="inputPassword3" class="col-sm-2 col-form-label">도서관코드</label>
			                    <div class="col-sm-10">
			                    	<input type="text" class="form-control" placeholder="Library Code" name="libraryCode">
			                    </div>
		                    </div>
                  <div class="form-group row">
                    <label for="inputPassword3" class="col-sm-2 col-form-label">저자</label>
	                    <div class="col-sm-4">
	                      <input type="text" class="form-control" placeholder="Writer Name" name="writerName">
	                    </div>
                    <label for="inputPassword3" class="col-sm-2 col-form-label">가격</label>
	                    <div class="col-sm-4">
	                      <input type="text" class="form-control" placeholder="Book Price"name="bookPrice">
	                    </div>
                  </div>
                  <div class="form-group row">
                    <label for="inputPassword3" class="col-sm-2 col-form-label">출간날짜</label>
	                    <div class="col-sm-4">
	                      <input type="text" class="form-control" placeholder="Book Publish Date" name="bookPublishDate">
	                    </div>
                    <label for="inputPassword3" class="col-sm-2 col-form-label">등록날짜</label>
	                    <div class="col-sm-4">
	                      <input type="text" class="form-control" placeholder="Book Reg Date" name="bookRegDate">
	                    </div>
                  </div>
                  <div class="form-group row">
                  	<label for="inputPassword3" class="col-sm-2 col-form-label">도서상태</label>
                  	<div class="col-sm-4">
                  		<button type="button" class="fc-today-button btn btn-primary" name="bookSituation"></button>
                  	</div>
                  	<label for="inputPassword3" class="col-sm-2 col-form-label">연체일수</label>
                  	<div class="col-sm-4">
                  		<button type="button" class="fc-today-button btn btn-primary" name="rentCanSituation"></button>
                  	</div>
                  </div>                 
                </div>
                <!-- /.card-body -->
            </div>
            <!-- /.card -->
          </div>
		<!-- /.col -->
						
				<div class="col-md-6">
			          <div class="card card-white">
	                <div class="card-body">
	                  <div class="form-group row">
	                    <label for="inputEmail3" class="col-sm-2 col-form-label">회원 아이디</label>
		                    <div class="col-sm-10">
		                      <input type="text" class="form-control" placeholder="Member Id" name="memberId">
		                    </div>
	                  </div>
	                  <div class="form-group row">
	                    <label for="inputEmail3" class="col-sm-2 col-form-label">회원 이름</label>
		                    <div class="col-sm-10">
		                      <input type="text" class="form-control" placeholder="Member Name" name="memberName">
		                    </div>
		              </div>
	                  <div class="form-group row">
	                    <label for="inputEmail3" class="col-sm-2 col-form-label">생년 월일</label>
		                    <div class="col-sm-10">
		                      <input type="Date" class="form-control" name="memberBirth">
		                    </div>
	                  </div>
	                  <div class="form-group row">
	                    <label for="inputPassword3" class="col-sm-2 col-form-label">회원 레벨</label>
		                    <div class="col-sm-10">
		                      <input type="text" class="form-control" placeholder="Member Level" name="levelCode">
		                    </div>
	                  </div>
	                  <div class="form-group row">
	                    <label for="inputPassword3" class="col-sm-2 col-form-label">주소</label>
		                    <div class="col-sm-10">
		                      <input type="text" class="form-control" placeholder="Member Address" name="memberAddress">
		                    </div>
	                  </div>
	                  <div class="form-group row">
	                    <label for="inputPassword3" class="col-sm-2 col-form-label">전화번호</label>
		                    <div class="col-sm-10">
		                      <input type="text" class="form-control" placeholder="Member Tel" name="memberTel">
		                    </div>
	                  </div>
	                  <div class="form-group row">
	                    <label for="inputPassword3" class="col-sm-2 col-form-label">이메일</label>
		                    <div class="col-sm-10">
		                      <input type="email" class="form-control" placeholder="Member Email" name="memberEmail">
		                    </div>
	                  </div>
	                  <div class="form-group row">
                  		<label for="inputPassword3" class="col-sm-2 col-form-label">현재대여중</label>
		                  	<div class="col-sm-4">
		                  		<button type="button" class="fc-today-button btn btn-danger" name="rentCount"></button>
		                  	</div>
                  			<label for="inputPassword3" class="col-sm-3 col-form-label">대여가능권수</label>                 	
                  			<button type="button" class="fc-today-button btn btn-danger" name="rentCan"></button>               
                  	  </div>	            
	                </div>
	                <!-- /.card-body -->
	            </div>
	            	<!-- /.card -->
	          </div>
			  	  <!-- /.col -->
			</div>
				<!-- /.row -->
			
			<!-- modal-Return_button -->
			<div class="row">
				<div class="col-md-12" style="text-align: center; margin-bottom: 10px">				
					<button type="button" class="fc-today-button btn btn-info" data-toggle="modal" data-target="#modal-Return" disabled="disabled" id="returnBtn">#반납하기</button>			
				<div class="btnText" style="color: red">
				</div>
				</div>
			</div>
			<!-- modal-Return_button -->
			
			<div class="modal fade" id="modal-Return">
		        <div class="modal-dialog">
		          <div class="modal-content bg-default">
		            <div class="modal-header">
		              <h4 class="modal-title">반납관리</h4>
		              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
		                <span aria-hidden="true">&times;</span></button>
		            </div>
		            <div class="modal-body">
		              <p>반납 하시겠습니까?</p>
		            </div>
		            <div class="modal-footer justify-content-between">
		              <button type="button" class="btn" data-dismiss="modal" style="background-color: Snow; border: outset;">Close</button>
		              <button type="submit" class="btn" style="background-color: Snow; border: outset;">#반납하기</button>
		            </div>
		          </div>
		          <!-- /.modal-content -->
		        </div>
		        <!-- /.modal-dialog -->
      		</div>
      <!-- /.modal -->
			</form>
			
      <div class="col-12">
            <div class="card">
              <div class="card-header">
               <form role="form" action="officeReturnListSearch" method="get">
							<div class="row">
								<div class="col-sm-3">
									<div class="form-group">
				                        <select class="form-control custom-select" name="sk">
				                          <option value= "t.return_code">반납 코드</option>
				                          <option value= "t.member_id">회원 아이디</option>
				                          <option value= "t.return_reg_date">반납 날짜(YYYYMMdd)</option>
				                          <option value= "b.book_name">도서 이름</option>
				                          <option value= "b.book_library_code">청구기호</option>
				                          <option value= "w.writer_name">저자</option>
				                          <option value= "c.category_name">카테고리</option>
				                          <option value= "p.publisher_name">도서 출판사</option> 
				                        </select>
				                    </div>
								</div>
								<div class="col-sm-9">
									<div class="row">
										<div class="col-sm-10">
											<input class="form-control" type="text" name="sv" placeholder="반납 도서 이력 검색하기">
										</div>
										<div class="col-sm-2">
											<div class="input-group-append">
			                          			 <button class="btn btn-navbar" type="submit">
			                           			  <i class="fas fa-search"></i>
			                          			  </button>
			                          		</div>
		                          		</div>
	                          		</div>
								</div>
		                    </div>							
						</form>
		              </div>
		           <!-- /.card-header -->
		           
		           <div id="example2_wrapper" class="dataTables_wrapper dt-bootstrap4">	 
	                	<div class="row">
	                		<div class="col-sm-12">
				                <table id="example2" class="table table-bordered table-hover dataTable dtr-inline" role="grid" aria-describedby="example2_info">
				                  <thead>
				                    <tr>
				                      <th>반납코드</th>
				                      <th>반납회원</th>
				                      <th>반납날짜</th>
				                      <th>도서이름</th>
				                      <th>청구기호</th>
				                      <th>저자</th>
				                      <th>카테고리</th>
				                      <th>도서출판사</th>
				                      <th>미반납처리</th>
				                  	  <th>삭제</th>
				                    </tr>
				                  </thead>
				                  <tbody>
				                    <tr th:each="R : ${officeReturnList}">
				                      <td th:text="${R.returnCode}"></td>
				                      <td th:text="${R.memberId}"></td>
				                      <td th:text="${R.returnDate}"></td>
				                      <td th:text="${R.book.bookName}"></td>
				                      <td th:text="${R.book.bookLibraryCode}"></td>
				                      <td th:text="${R.writer}"></td>
				                      <td th:text="${R.category}"></td>
				                      <td th:text="${R.publisher}"></td>
				                      <td>
				                      	<a class="btn btn-info btn-sm" data-toggle="modal" data-target="#modal-update" style="color: white">미반납처리</a>
				                      </td>
				                      <td class="">
				                      	<a class="btn btn-danger btn-sm" data-toggle="modal" data-target="#modal-delete" style="color: white">삭제</a>
							          </td>
				                    </tr>
				                 </tbody>
				               </table>
	                		</div>
                			<!-- /.col -->            		
                	</div>
                		<!-- /.row -->
               	</div>
               		<!-- /.dataTables_wrapper -->
          </div>
          		<!-- /.card -->
       </div>           
          
	                <!-- modal --> 
	                <div class="modal fade" id="modal-update">
				        <div class="modal-dialog">
				          <div class="modal-content bg-default">
				            <div class="modal-header">
				              <h4 class="modal-title">반납도서관리</h4>
				              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				                <span aria-hidden="true">&times;</span></button>
				            </div>
				            <div class="modal-body">
				              <p>해당 도서가 '대여 중' 상태로 바뀌어 포인트 1점 감점 됩니다.</p>
				              <p>정말 하시겠습니까?</p>
				            </div>
				            <div class="modal-footer justify-content-between">
				              <button type="button" class="btn" data-dismiss="modal">Close</button>
				              <button type="button" class="btn">#OK</button>
				            </div>
				          </div>
				          <!-- /.modal-content -->
				        </div>
				        <!-- /.modal-dialog -->
		      		</div>
		      		<div class="modal fade" id="modal-delete">
				        <div class="modal-dialog">
				          <div class="modal-content bg-default">
				            <div class="modal-header">
				              <h4 class="modal-title">반납도서관리</h4>
				              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
				                <span aria-hidden="true">&times;</span></button>
				            </div>
				            <div class="modal-body">
				              <p>삭제 하시겠습니까?</p>
				            </div>
				            <div class="modal-footer justify-content-between">
				              <button type="button" class="btn" data-dismiss="modal">Close</button>
				              <button type="button" class="btn">#삭제하기</button>
				            </div>
				          </div>
				          <!-- /.modal-content -->
				        </div>
				        <!-- /.modal-dialog -->
		      		</div>
		      <!-- /.modal -->
		      
		      	
	</section>
	<!-- /.content -->
</div>
<!-- /.content-wrapper -->
</th:block>
<th:block layout:fragment="customFooterScript">
<!-- jQuery -->
<script src="../../plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- DataTables -->
<script src="../../plugins/datatables/jquery.dataTables.min.js"></script>
<script src="../../plugins/datatables-bs4/js/dataTables.bootstrap4.min.js"></script>
<script src="../../plugins/datatables-responsive/js/dataTables.responsive.min.js"></script>
<script src="../../plugins/datatables-responsive/js/responsive.bootstrap4.min.js"></script>
<script>
	$(function(){
		//데이터테이블
		$("#example1").DataTable({
	      "responsive": true,
	      "autoWidth": false,
	    });
	    $('#example2').DataTable({
	      "paging": true,
	      "lengthChange": false,
	      "searching": false,
	      "ordering": true,
	      "info": true,
	      "autoWidth": false,
	      "responsive": true,
	    });
		
	    //삭제 버튼 클릭시 모달
		/* $('.RentDeleteBtn').click(function(){
			console.log("삭제클릭");
			var value = $(this).val();
			console.log(value);
			var request = $.ajax({
			  url: "/selectRent",
  			  method: "get",
  			  data: { rentCode : value },
  			  dataType: "json"
			});
			request.done(function( data ) {
	 			console.log(JSON.stringify(data) + " <- ajax");
				$('#deleteRentCode').val(data.rentCode);
				$('#deleteModal').modal();
  			});
			request.fail(function( jqXHR, textStatus ) {
  			  alert( "Request failed: " + textStatus );
  			});
		}) */
		
		//회원 아이디로 검색시 회원 정보 검색하여 화면에 출력
		$('#searchMember').on('click',function(){
			var value = $('#searchMemberId').val();
			console.log(value);
			if(value == '' || value == null || value == undefined || value == 0 || value == NaN){
				alert('회원 id를 입력하세요');				
			}else {
				var request = $.ajax({
		  			  url: "/return/getSelectMember",
		  			  method: "get",
		  			  data: { memberId : value },
		  			  dataType: "json"
		  			});
				request.done(function( data ) {
	  				console.log(JSON.stringify(data) + " <- ajax");
	  				$('[name=memberId]').val(data.memberId);
	  				$('[name=memberName]').val(data.memberName);
	  				$('[name=memberBirth]').val(data.memberBirth);
	  				$('[name=levelCode]').val(data.levelCode);
	  				$('[name=memberAddress]').val(data.memberAddress);
	  				$('[name=memberTel]').val(data.memberTel);
	  				$('[name=memberEmail]').val(data.memberEmail);
	  				$('[name=rentCount]').html(data.rentCount+"권");
	  				
	  				 //레벨이 일반회원일때(5,6,7) 대여가능횟수는 5권
	  				if(data.levelCode == '5' || data.levelCode == '6' || data.levelCode == '7'){
	  					var rentCanCount = 5; //대여가능횟수
	  					console.log("data.rentCount = " + data.rentCount); //현재 대여권수
	  					var rentCan = rentCanCount-data.rentCount; //남은 대여가능 횟수
	  					console.log("rentCan = " + rentCan);
	  					$('[name=levelCode]').val('일반회원');
	  					$('[name=rentCan]').html(rentCan+"권");
	  				//레벨이 우수회원일때(4) 대여가능횟수는 7권
	  				}else if(data.levelCode == '4'){
	  					var rentCanCount = 7; //대여가능횟수
	  					console.log("data.rentCount = " + data.rentCount); //현재 대여권수
	  					var rentCan = rentCanCount-data.rentCount; //남은 대여가능 횟수
	  					console.log("rentCan = " + rentCan);
	  					$('[name=levelCode]').val('우수회원');
	  					$('[name=rentCan]').html(rentCan+"권");
	  				//레벨이 제재회원일때(8) 대여가능횟수는 3권
	  				}else if(data.levelCode == '8'){
	  					var rentCanCount = 3; //대여가능횟수
	  					console.log("rentCanCount = " + rentCanCount);
	  					console.log("data.rentCount = " + data.rentCount); //현재 대여권수
	  					var rentCan = rentCanCount-data.rentCount; //남은 대여가능 횟수
	  					console.log("rentCan = " + rentCan); 
	  					$('[name=levelCode]').val('제재회원');
	  					$('[name=rentCan]').html(rentCan+"권");
	  				}else{
	  					var rentCanCount = 0; //대여가능횟수
	  					console.log("data.rentCount = " + data.rentCount); //현재 대여권수
	  					var rentCan = rentCanCount-data.rentCount; //남은 대여가능 횟수
	  					console.log("rentCan = " + rentCan);
	  					$('[name=levelCode]').val('휴먼회원');
	  					$('[name=rentCan]').html(rentCan+"권");
	  					console.log($('[name=rentCan]').html());
	  				}
	  				//대여가능 권수가 0권이 아니거나 도서상태가 대여 가능이면 대여하기 버튼 활성화
	  				if($('[name=rentCount]').html() != "0권" && $('[name=rentCanSituation]').html() == '반납가능' && $('[name=rentCount]').html() != ''){
	  					$('#returnBtn').removeAttr("disabled");
	  					$('.btnText').text("");
	  				}else if($('[name=rentCount]').html() == "0권"){
	  					$('#returnBtn').attr("disabled","disabled");
	  					$('.btnText').text("대여한 도서가 없습니다.");
	  				} 
			});
				request.fail(function( jqXHR, textStatus ) {
		  			  alert( "회원 정보를 찾을 수 없습니다.  :  " + textStatus );
		  			});
				};
			});
		//도서로 검색시 도서정보 검색하여 화면에 출력
		$('#searchBook').on('click',function(){
			var value = $('#searchBookLibraryCode').val();
			console.log(value);
			if(value == '' || value == null || value == undefined || value == 0 || value == NaN){
				alert('청구기호를 입력하세요');				
			}else {
				var request = $.ajax({
		  			  url: "/return/getSelectBook",
		  			  method: "get",
		  			  data: { bookLibraryCode : value },
		  			  dataType: "json"
		  			});
				request.done(function( data ) {
	  				console.log(JSON.stringify(data) + " <- ajax");
	  				$('[name=bookLibraryCode]').val(data.bookLibraryCode);
	  				$('[name=bookCode]').val(data.bookCode);
	  				$('[name=bookIsbn]').val(data.bookIsbn);
	  				$('[name=bookName]').val(data.bookName);
	  				$('[name=libraryCode]').val(data.libraryCode);
	  				$('[name=writerName]').val(data.writerName);
	  				$('[name=bookPrice]').val(data.bookPrice);
	  				$('[name=bookPublishDate]').val(data.bookPublishDate);
	  				$('[name=bookRegDate]').val(data.bookRegDate);
	  				$('[name=bookSituation]').html(data.bookSituation);
	  				
	  				if(data.bookSituation == '보유 중'|| data.bookSituation == '예약 중'){
	  					$('[name=rentCanSituation]').html('반납불가');
	  				}else{
	  					$('[name=rentCanSituation]').html('반납가능');
	  				}
	  				//대여가능 권수가 0이 아니거나 도서상태가 대여 가능이면 대여하기 버튼 활성화
	  				if($('[name=rentCanSituation]').html() == '반납가능' && $('[name=rentCount]').html() != "0권" && $('[name=rentCan]').html() != ''){
	  					$('#returnBtn').removeAttr("disabled");
	  					$('.btnText').text("");
	  				}else if($('[name=rentCanSituation]').html() == '반납불가'){
	  					$('#returnBtn').attr("disabled","disabled");
	  					$('.btnText').text("해당 도서는 "+data.bookSituation+" 상태로 반납할 수 없습니다.");
	  				}else if($('[name=rentCanSituation]').html() == '반납가능'){
	  					$('.btnText').text("");
	  				}
	  				});
				request.fail(function( jqXHR, textStatus ) {
		  			  alert( "도서 정보를 찾을 수 없습니다.  :  " + textStatus );
		  			});
			}
		});    
	});
</script>
</th:block>
</html>